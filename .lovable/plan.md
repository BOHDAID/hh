

# خطة: فصل مسارات التفعيل بالكامل (Crunchyroll / OSN / ChatGPT)

## المشكلة الجذرية

رغم إضافة كود الكشف التلقائي والتحويل، المستخدم لا يزال يرى تعليمات OSN عند اختيار "هاتف" لمنتج Crunchyroll. الأسباب المحتملة:

1. الجلسة القديمة في قاعدة البيانات لا تزال في حالة `in_progress` (حالة OSN) ويتم إعادة بنائها بنوع خاطئ
2. الدالة قد لا تكون منشورة بالنسخة الأخيرة
3. منطق `reconstructSession` يعيد بناء الجلسة كـ OSN لأن الحالة في DB هي `in_progress`

## الحل المقترح

### 1. إعادة نشر الدالة والتحقق من عملها

- إعادة نشر `telegram-bot-webhook` بشكل صريح
- اختبار الدالة مباشرة للتأكد أنها تعمل

### 2. تنظيف الجلسات العالقة بالقوة

- إضافة تنظيف شامل لجميع الجلسات القديمة المرتبطة بالمستخدم عند إدخال كود جديد
- عدم الاعتماد على مهلة 30 دقيقة فقط - تنظيف فوري عند `/cancel`

### 3. تعزيز منطق إعادة بناء الجلسة

في دالة `reconstructSession`:
- فحص اسم المنتج أولا قبل حالة الكود في DB
- إذا المنتج "Crunchyroll" والحالة `in_progress` (حالة OSN)، تحويلها تلقائيا لـ `crunchyroll_choose`

### 4. إضافة حماية ثلاثية في choose_otp/choose_qr

الحماية الموجودة تفحص `session.productName` - لكن يجب أيضا:
- فحص `session.activationType` المخزن
- إعادة جلب اسم المنتج من DB إذا لزم الأمر

---

## التفاصيل التقنية

### ملف: `supabase/functions/telegram-bot-webhook/index.ts`

**التعديل 1: تحسين `reconstructSession`**
- عند إعادة بناء الجلسة، إذا الحالة في DB هي `in_progress` واسم المنتج يحتوي "crunch"، تعيين `activationType = "crunchyroll"` و `step = "crunchyroll_choose"` بدل `awaiting_login`

**التعديل 2: تعزيز حماية choose_otp**
- إضافة إعادة جلب بيانات المنتج من DB مباشرة في حالة عدم تطابق البيانات
- سجل تفصيلي (log) لكل خطوة لتسهيل التصحيح

**التعديل 3: تحديث حالة DB فورا**
- عند اكتشاف أن المنتج Crunchyroll في أي مرحلة، تحديث حالة الكود في DB من `in_progress` إلى `crunchyroll_choosing` فورا

### إعادة النشر
- إعادة نشر الدالة `telegram-bot-webhook` بعد التعديلات
- التحقق من السجلات بعد النشر

---

## خطوات التنفيذ

1. تعديل `reconstructSession` لتحويل الجلسات `in_progress` إلى `crunchyroll_choose` عند اكتشاف المنتج
2. تعزيز حماية `choose_otp`/`choose_qr` بإعادة جلب بيانات المنتج من DB
3. إضافة سجلات تفصيلية في كل مرحلة
4. إعادة نشر الدالة
5. اختبار التدفق

